name: Descargar documento programado

on:
  schedule:
    - cron: '0 9-21 * * *'   # <-- Cambia aquÃ­ los horarios deseados

jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # 1ï¸âƒ£ Definir variables (dos URLs)
      - name: Definir variables
        env:
          FILE_URLS: |
            https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_iptv.m3u
            https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_fuera_iptv.m3u
            https://ipfs.io/ipns/k2k4r8oqlcjxsritt5mczkcn4mmvcmymbqw7113fz2flkrerfwfps004/data/listas/lista_kodi.m3u
          OUTPUT_DIR: ./rep
        run: |
          mkdir -p "$OUTPUT_DIR"
          echo "Variables listas"

      # 2ï¸âƒ£ Descargar cada archivo
      - name: Descargar archivos con curl
        env:
          FILE_URLS: ${{ env.FILE_URLS }}
          OUTPUT_DIR: ${{ env.OUTPUT_DIR }}
        run: |
          # Recorrer cada lÃ­nea (cada URL)
          i=1
          while IFS= read -r url; do
            # Extraer nombre de archivo (Ãºltimo segmento despuÃ©s de '/')
            filename=$(basename "$url")
            # Si la URL no termina con un nombre Ãºtil, usamos un Ã­ndice
            if [[ -z "$filename" || "$filename" == */ ]]; then
              filename="archivo_$i"
            fi
            output_path="${OUTPUT_DIR}/${filename}"
            echo "Descargando $url â†’ $output_path"
            curl -L "$url" -o "$output_path"
            ((i++))
          done <<< "$FILE_URLS"

      # 3ï¸âƒ£ Subir como artefacto (todos los archivos)
      - name: Guardar como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentos-descargados
          path: ${{ env.OUTPUT_DIR }}/**

      # 4ï¸âƒ£ (Opcional) Commit & push de los archivos
      - name: Commit y push
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add "${{ env.OUTPUT_DIR }}/**"
          git commit -m "ðŸ“¥ Descarga automÃ¡tica de documentos $(date +'%Y-%m-%d %H:%M')"
          git pushEJEM
