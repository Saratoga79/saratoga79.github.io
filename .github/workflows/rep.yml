name: Descargar m√∫ltiples documentos (con variable)

# -------------------------------------------------
# 1Ô∏è‚É£  Permisos del token (escritura sobre el repo)
# -------------------------------------------------
permissions:
  contents: write   # permite crear commits y hacer push

# -------------------------------------------------
# 2Ô∏è‚É£  Triggers
# -------------------------------------------------
on:
  # Run Cada hora
  schedule:
    - cron: '0 0 * * *'

  # Permite lanzar el workflow manualmente para pruebas / depuraci√≥n
  workflow_dispatch:
    inputs:
      debug:
        description: 'Activar modo debug (true/false)'
        required: false
        default: 'false'

# -------------------------------------------------
# 3Ô∏è‚É£  Job
# -------------------------------------------------
jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 3.1Ô∏è‚É£ Checkout (necesario para poder hacer commit)
      # -------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 3.2Ô∏è‚É£ Instalar jq (para leer el JSON)
      # -------------------------------------------------
      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # -------------------------------------------------
      # 3.3Ô∏è‚É£ Mostrar el JSON (diagn√≥stico)
      # -------------------------------------------------
      - name: Mostrar JSON usado
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
        run: |
          echo "===== CONTENIDO DE DOWNLOADS_JSON ====="
          printf '%s\n' "$DOWNLOADS_JSON"
          echo "=========================================="

      # -------------------------------------------------
      # 3.4Ô∏è‚É£ Descargar cada archivo a un **temporal** y mover solo si OK
      # -------------------------------------------------
      - name: Descargar seg√∫n JSON (seguro)
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        run: |
          # Activar modo debug si el usuario lo pidi√≥
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi

          # Recorrer cada objeto del array JSON
          echo "$DOWNLOADS_JSON" | jq -c '.[]' | while read -r item; do
            url=$(echo "$item" | jq -r '.url')
            dest=$(echo "$item" | jq -r '.dest')
            # Archivo temporal √∫nico (evita colisiones)
            tmp="${dest}.tmp.$RANDOM"

            # Aseguramos que exista el directorio destino
            mkdir -p "$(dirname "$dest")"

            echo "‚ñ∂Ô∏è  Descargando $url ‚Üí $tmp (temporal)"
            # -f: falla con c√≥digos HTTP >=400
            # -L: sigue redirecciones
            curl -fSL "$url" -o "$tmp"
            rc=$?

            if [ $rc -ne 0 ]; then
              echo "‚ùå  ERROR al descargar $url (c√≥digo $rc). Mantengo $dest sin cambios."
              rm -f "$tmp"
              continue
            fi

            # Verificar que el archivo temporal no est√© vac√≠o
            if [ ! -s "$tmp" ]; then
              echo "‚ö†Ô∏è  Archivo temporal vac√≠o; no sustituyo $dest."
              rm -f "$tmp"
              continue
            fi

            # Todo OK ‚Üí reemplazar el archivo definitivo
            echo "‚úÖ  Descarga completada. Reemplazando $dest."
            mv -f "$tmp" "$dest"
          done

      # -------------------------------------------------
      # 3.5Ô∏è‚É£ Listar el contenido final (para que puedas verlo en los logs)
      # -------------------------------------------------
      - name: Listar contenido de downloads/
        if: always()
        run: |
          echo "=== LISTADO FINAL DE downloads/ ==="
          ls -R downloads/ || echo "Carpeta downloads/ no encontrada"
          echo "===================================="

      # -------------------------------------------------
      # 3.6Ô∏è‚É£ Subir artefactos (siempre disponible para descarga)
      # -------------------------------------------------
      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentos-multiples
          path: downloads/**

      # -------------------------------------------------
      # 3.7Ô∏è‚É£ Commit y push **solo si hubo cambios reales**
      # -------------------------------------------------
      - name: Commit y push de los archivos descargados
        # S√≥lo se ejecuta si el job termin√≥ sin errores
        if: success()
        run: |
          # Configuraci√≥n del usuario de GitHub Actions
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # A√±adir los cambios (solo los archivos bajo downloads/)
          git add downloads/**

          # ¬øHay diferencias respecto al √∫ltimo commit?
          # `git diff-index --quiet HEAD` devuelve 0 si NO hay cambios,
          # 1 si hay cambios. Usamos la l√≥gica OR para crear el commit solo cuando sea necesario.
          if ! git diff-index --quiet HEAD; then
            git commit -m "üì• Descarga autom√°tica $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "üîé  No se detectaron cambios en los archivos; no se crea commit."
          fi