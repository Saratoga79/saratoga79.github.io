name: Descargar m√∫ltiple con reintentos + proxy
on:
  schedule:
    - cron: '0 * * * *'          # cada hora
  workflow_dispatch:

jobs:
  download:
    runs-on: ubuntu-latest
    steps:

      # -------------------------------------------------
      # 0Ô∏è‚É£ Instalar herramientas necesarias
      # -------------------------------------------------
      - name: Instalar jq
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq

      # -------------------------------------------------
      # 1Ô∏è‚É£ Checkout del repositorio (necesario para commit/push)
      # -------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      # -------------------------------------------------
      # 2Ô∏è‚É£ Estrategia combinada (reintentos + proxy)
      # -------------------------------------------------
      - name: Descargar seg√∫n JSON (seguro)
        # -----------------------------------------------------------------
        # Si quieres usar un proxy HTTP (tinyproxy, squid, etc.) descomenta:
        # env:
        #   http_proxy:  http://127.0.0.1:8888
        #   https_proxy: http://127.0.0.1:8888
        # -----------------------------------------------------------------
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        run: |
          # ----------------------------------------------
          # Preparaci√≥n general
          # ----------------------------------------------
          set -u -o pipefail               # falla en pipelines, pero no en comandos individuales
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi

          # ----------------------------------------------
          # Desactivar errexit mientras iteramos
          # ----------------------------------------------
          set +e                           # <-- evita que cualquier comando con rc‚â†0 aborta el script

          echo "$DOWNLOADS_JSON" | jq -c '.[]' | while read -r item; do
            url=$(echo "$item" | jq -r '.url')
            dest=$(echo "$item" | jq -r '.dest')
            tmp="${dest}.tmp.$RANDOM"

            # Asegurar que exista el directorio destino
            mkdir -p "$(dirname "$dest")"

            echo "::group::Descargando $url ‚Üí $tmp"
            #   --max-time 300  ‚Üí timeout de 5‚ÄØmin
            #   --retry 5      ‚Üí hasta 5 intentos
            #   --retry-delay 10 ‚Üí 10‚ÄØs entre intentos
            curl -fSL --max-time 300 --retry 5 --retry-delay 10 "$url" -o "$tmp"
            rc=$?                         # captura c√≥digo de salida de curl
            echo "::endgroup::"

            # -------------------------------------------------
            # Manejo de errores (504, 502, 5xx, etc.)
            # -------------------------------------------------
            if [ $rc -ne 0 ]; then
              echo "‚ùå  ERROR al descargar $url (c√≥digo $rc). Se omite y se contin√∫a."
              rm -f "$tmp"
              continue                    # pasa a la siguiente URL
            fi

            # -------------------------------------------------
            # Archivo temporal vac√≠o ‚Üí descartamos
            # -------------------------------------------------
            if [ ! -s "$tmp" ]; then
              echo "‚ö†Ô∏è  Archivo temporal vac√≠o; no sustituyo $dest."
              rm -f "$tmp"
              continue
            fi

            # -------------------------------------------------
            # (Opcional) checksum SHA‚Äë256
            # -------------------------------------------------
            # expected=$(echo "$item" | jq -r '.sha256 // empty')
            # if [ -n "$expected" ]; then
              # echo "$expected  $tmp" | sha256sum -c - >/dev/null || {
                # echo "‚ùå  Checksum fall√≥ para $url ‚Üí $tmp. Archivo descartado."
                # rm -f "$tmp"
                # continue
              # }
            # fi

            # -------------------------------------------------
            # Todo correcto ‚Üí mover al destino definitivo
            # -------------------------------------------------
            echo "‚úÖ  Descarga completada. Reemplazando $dest."
            mv -f "$tmp" "$dest"
          done

          # ----------------------------------------------
          # Reactivar errexit para el resto del job
          # ----------------------------------------------
          set -e

          # (opcional) resumen final
          echo "=== LISTADO FINAL DE downloads/ ==="
          find downloads/ -type f -print
          echo "===================================="

      # -------------------------------------------------
      # 3Ô∏è‚É£ Listar contenido final (para depuraci√≥n)
      # -------------------------------------------------
      - name: Listar contenido de downloads/
        if: always()
        run: |
          echo "=== LISTADO FINAL DE downloads/ ==="
          find downloads/ -type f -print
          echo "===================================="

      # -------------------------------------------------
      # 4Ô∏è‚É£ Empaquetar y subir artefactos
      # -------------------------------------------------
      - name: Empaquetar artefactos
        run: tar -czf documentos-multiples.tar.gz downloads/

      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentos-multiples
          path: documentos-multiples.tar.gz

      # -------------------------------------------------
      # 5Ô∏è‚É£ Commit y push (solo si hay cambios)
      # -------------------------------------------------
      - name: Commit y push de los archivos descargados
        if: success()
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A downloads/
          if ! git diff-index --quiet HEAD; then
            git commit -m "üì• Descarga autom√°tica $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "üîé  No se detectaron cambios en los archivos; no se crea commit."
          fi