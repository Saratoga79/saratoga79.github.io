# -------------------------------------------------
# 3️⃣ Estrategia combinada (reintentos + proxy)
# -------------------------------------------------
- name: Descargar según JSON (seguro)
  # Si utilizas un proxy HTTP, define aquí sus variables.
  # Puedes comentar estas líneas si no quieres usar proxy.
  env:
    DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
    DEBUG_MODE: ${{ github.event.inputs.debug }}
    # Ejemplo con proxy HTTP local (tinyproxy en 127.0.0.1:8888)
    http_proxy:  http://127.0.0.1:8888
    https_proxy: http://127.0.0.1:8888
    # Si usas SOCKS5, comenta las dos líneas anteriores y descomenta:
    # ALL_PROXY: socks5h://127.0.0.1:1080
  run: |
    # ------------------------------------------------------------------
    # Preparación básica
    # ------------------------------------------------------------------
    set -u               # error si usamos variable sin definir
    set -o pipefail      # propagación de errores en pipelines

    # Activar modo debug si el input lo solicita
    if [ "${DEBUG_MODE}" = "true" ]; then
      set -x
    fi

    # ------------------------------------------------------------------
    # Procesar cada elemento del JSON
    # ------------------------------------------------------------------
    echo "$DOWNLOADS_JSON" | jq -c '.[]' | while read -r item; do
      url=$(echo "$item" | jq -r '.url')
      dest=$(echo "$item" | jq -r '.dest')
      tmp="${dest}.tmp.$RANDOM"

      # Garantizar que el directorio destino exista
      mkdir -p "$(dirname "$dest")"

      # ----------------------- LOGS AGRUPADOS -----------------------
      echo "::group::Descargando $url → $tmp"
      #   • --max-time 300  → timeout ampliado (5 min)
      #   • --retry 5      → hasta 5 intentos
      #   • --retry-delay 10 → espera 10 s entre reintentos
      #   • proxy se toma de $http_proxy / $https_proxy / $ALL_PROXY
      curl -fSL \
           --max-time 300 \
           --retry 5 --retry-delay 10 \
           "$url" -o "$tmp"
      rc=$?
      echo "::endgroup::"
      # ----------------------------------------------------------------

      # Si curl falla, registrar y pasar al siguiente ítem
      if [ $rc -ne 0 ]; then
        echo "❌  ERROR al descargar $url (código $rc). Se omite."
        rm -f "$tmp"
        continue
      fi

      # Comprobar que el archivo temporal no esté vacío
      if [ ! -s "$tmp" ]; then
        echo "⚠️  Archivo temporal vacío; no sustituyo $dest."
        rm -f "$tmp"
        continue
      fi

      # ------------------- Opcional: checksum SHA‑256 -------------------
      expected=$(echo "$item" | jq -r '.sha256 // empty')
      if [ -n "$expected" ]; then
        echo "$expected  $tmp" | sha256sum -c - >/dev/null
        if [ $? -ne 0 ]; then
          echo "❌  Checksum falló para $url → $tmp. Archivo descartado."
          rm -f "$tmp"
          continue
        fi
      fi
      # ------------------------------------------------------------------

      echo "✅  Descarga completada. Reemplazando $dest."
      mv -f "$tmp" "$dest"
    done