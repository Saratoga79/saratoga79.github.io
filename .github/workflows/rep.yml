name: Descargar m√∫ltiples documentos (con variable)

# -------------------------------------------------
# 1Ô∏è‚É£  Triggers
# -------------------------------------------------
on:
  # Ejecuci√≥n programada: cada hora entre las 09:00‚ÄØy‚ÄØ21:00‚ÄØUTC
  schedule:
    - cron: '0 9-21 * * *'

  # Disparador manual (aparecer√° el bot√≥n ‚ÄúRun workflow‚Äù)
  workflow_dispatch:
    inputs:
      debug:
        description: 'Activar modo debug (true/false)'
        required: false
        default: 'false'

# -------------------------------------------------
# 2Ô∏è‚É£  Job
# -------------------------------------------------
jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 2.1Ô∏è‚É£ Checkout (solo necesario si vas a hacer commit)
      # -------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4

      # -------------------------------------------------
      # 2.2Ô∏è‚É£ Instalar jq (para parsear JSON)
      # -------------------------------------------------
      - name: Instalar jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # -------------------------------------------------
      # 2.3Ô∏è‚É£ Mostrar el JSON que vamos a procesar (diagn√≥stico)
      # -------------------------------------------------
      - name: Mostrar JSON usado
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}   # <-- variable del repo
        run: |
          echo "===== CONTENIDO DE DOWNLOADS_JSON ====="
          printf '%s\n' "$DOWNLOADS_JSON"
          echo "=========================================="

      # -------------------------------------------------
      # 2.4Ô∏è‚É£ Descargar seg√∫n JSON (crea carpetas autom√°ticamente)
      # -------------------------------------------------
      - name: Descargar seg√∫n JSON (variable)
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        run: |
          # Si el usuario activ√≥ debug, mostramos cada comando antes de ejecutarlo
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi

          echo "$DOWNLOADS_JSON" | jq -c '.[]' | while read -r item; do
            url=$(echo "$item" | jq -r '.url')
            dest=$(echo "$item" | jq -r '.dest')

            # Crea la carpeta destino (incluye sub‚Äëdirectorios)
            mkdir -p "$(dirname "$dest")"

            echo "‚ñ∂Ô∏è  Descargando $url ‚Üí $dest"
            # -f: falla si el c√≥digo HTTP no es 2xx
            # -L: sigue redirecciones
            curl -fSL "$url" -o "$dest"
            rc=$?
            if [ $rc -ne 0 ]; then
              echo "‚ùå  ERROR al descargar $url (c√≥digo $rc)"
            else
              echo "‚úÖ  Descarga completada: $dest"
            fi
          done

      # -------------------------------------------------
      # 2.5Ô∏è‚É£ Listar el contenido final (para confirmar que hay archivos)
      # -------------------------------------------------
      - name: Listar contenido de downloads/
        if: always()
        run: |
          echo "=== LISTADO FINAL DE downloads/ ==="
          ls -R downloads/ || echo "Carpeta downloads/ no encontrada"
          echo "===================================="

      # -------------------------------------------------
      # 2.6Ô∏è‚É£ Subir artefactos (los archivos estar√°n disponibles para descarga)
      # -------------------------------------------------
      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentos-multiples
          path: downloads/**

      # -------------------------------------------------
      # 2.7Ô∏è‚É£ (Opcional) Commit & push de los archivos descargados
      # -------------------------------------------------
      - name: Commit y push de los archivos descargados
        if: success()          # solo si todas las descargas fueron exitosas
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add downloads/**
          git commit -m "üì• Descarga autom√°tica $(date +'%Y-%m-%d %H:%M')"
          git push