name: Descargar m√∫ltiples documentos (con variable)

# -------------------------------------------------
# 1Ô∏è‚É£  Permisos del token (escritura sobre el repo)
# -------------------------------------------------
permissions:
  contents: write   # permite crear commits y hacer push

# -------------------------------------------------
# 2Ô∏è‚É£  Triggers
# -------------------------------------------------
on:
  # Ejecutar cada hora (cambia a '0 0 * * *' si prefieres una vez al d√≠a)
  schedule:
    - cron: '0 * * * *'

  # Lanzamiento manual (√∫til para pruebas y modo debug)
  workflow_dispatch:
    inputs:
      debug:
        description: 'Activar modo debug (true/false)'
        required: false
        default: 'false'

# -------------------------------------------------
# 3Ô∏è‚É£  Job
# -------------------------------------------------
jobs:
  download:
    runs-on: ubuntu-latest

    steps:
      # -------------------------------------------------
      # 3.1Ô∏è‚É£ Checkout (necesario para poder hacer commit)
      # -------------------------------------------------
      - name: Checkout del repositorio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1   # solo el √∫ltimo commit, ahorra ancho de banda

      # -------------------------------------------------
      # 3.2Ô∏è‚É£ Instalar jq (versi√≥n ligera)
      # -------------------------------------------------
      - name: Instalar jq
        uses: jqlang/jq-action@v1

      # -------------------------------------------------
      # 3.3Ô∏è‚É£ Mostrar el JSON (diagn√≥stico)
      # -------------------------------------------------
      - name: Mostrar JSON usado
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
        run: |
          echo "===== CONTENIDO DE DOWNLOADS_JSON (primeros 5‚ÄØ000 bytes) ====="
          printf '%s\n' "$DOWNLOADS_JSON" | head -c 5000
          echo "... (truncado)"
          echo "=============================================================="

      # -------------------------------------------------
      # 3.4Ô∏è‚É£ Descargar cada archivo a un **temporal** y mover solo si OK
      # -------------------------------------------------
      - name: Descargar seg√∫n JSON (seguro)
        env:
          DOWNLOADS_JSON: ${{ vars.DOWNLOADS_JSON }}
          DEBUG_MODE: ${{ github.event.inputs.debug }}
        run: |
          set -euo pipefail

          # Activar modo debug si el usuario lo pidi√≥
          if [ "$DEBUG_MODE" = "true" ]; then set -x; fi

          # Recorrer cada objeto del array JSON
          echo "$DOWNLOADS_JSON" | jq -c '.[]' | while read -r item; do
            url=$(echo "$item" | jq -r '.url')
            dest=$(echo "$item" | jq -r '.dest')
            tmp="${dest}.tmp.$RANDOM"

            # Aseguramos que exista el directorio destino
            mkdir -p "$(dirname "$dest")"

            # -------------------- LOGS AGRUPADOS --------------------
            echo "::group::Descargando $url ‚Üí $tmp"
            # -f: falla con c√≥digos HTTP >=400
            # -L: sigue redirecciones
            # --max-time 120: timeout de 2‚ÄØmin
            # --retry 3 --retry-delay 5: reintentos en caso de fallos transitorios
            curl -fSL --max-time 120 --retry 3 --retry-delay 5 "$url" -o "$tmp"
            rc=$?
            echo "::endgroup::"
            # ---------------------------------------------------------

            if [ $rc -ne 0 ]; then
              echo "‚ùå  ERROR al descargar $url (c√≥digo $rc). Mantengo $dest sin cambios."
              rm -f "$tmp"
              continue
            fi

            # Verificar que el archivo temporal no est√© vac√≠o
            if [ ! -s "$tmp" ]; then
              echo "‚ö†Ô∏è  Archivo temporal vac√≠o; no sustituyo $dest."
              rm -f "$tmp"
              continue
            fi

            # ---------- OPCIONAL: checksum (sha256) ----------
            expected=$(echo "$item" | jq -r '.sha256 // empty')
            if [ -n "$expected" ]; then
              echo "$expected  $tmp" | sha256sum -c - >/dev/null
              if [ $? -ne 0 ]; then
                echo "‚ùå  Checksum fall√≥ para $url ‚Üí $tmp"
                rm -f "$tmp"
                continue
              fi
            fi
            # ------------------------------------------------

            echo "‚úÖ  Descarga completada. Reemplazando $dest."
            mv -f "$tmp" "$dest"
          done

      # -------------------------------------------------
      # 3.5Ô∏è‚É£ Listar el contenido final (para que puedas verlo en los logs)
      # -------------------------------------------------
      - name: Listar contenido de downloads/
        if: always()
        run: |
          echo "=== LISTADO FINAL DE downloads/ ==="
          find downloads/ -type f -print
          echo "===================================="

      # -------------------------------------------------
      # 3.6Ô∏è‚É£ Empaquetar y subir artefactos (m√°s compacto)
      # -------------------------------------------------
      - name: Empaquetar artefactos
        run: |
          tar -czf documentos-multiples.tar.gz downloads/
      - name: Subir artefactos
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: documentos-multiples
          path: documentos-multiples.tar.gz

      # -------------------------------------------------
      # 3.7Ô∏è‚É£ Commit y push **solo si hubo cambios reales**
      # -------------------------------------------------
      - name: Commit y push de los archivos descargados
        if: success()
        run: |
          # Configuraci√≥n del usuario de GitHub Actions
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"

          # A√±adir los cambios (solo los archivos bajo downloads/)
          git add -A downloads/

          # ¬øHay diferencias respecto al √∫ltimo commit?
          # `git diff-index --quiet HEAD` devuelve 0 si NO hay cambios,
          # 1 si hay cambios.
          if ! git diff-index --quiet HEAD; then
            git commit -m "üì• Descarga autom√°tica $(date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "üîé  No se detectaron cambios en los archivos; no se crea commit."
          fi